#!/bin/sh
# joker-run — выполняет СКРИПТ ИЛИ КОМАНДУ внутри joker

set -e

if [ $# -eq 0 ]; then
    echo "Usage: $0 <script.sh> | <command> [args...]"
    exit 1
fi

name="joker"
remote_host="127.0.0.1"

ssh_dir="${SSH_DIR:-"./.ssh"}"
ssh_opts=$(printf "%q " -i "$ssh_dir/id_ed25519" -o UserKnownHostsFile="$ssh_dir/known_hosts")

# Если первый аргумент — существующий файл, это скрипт
if [ -f "$1" ]; then
    script="$1"
    shift
    # Копируем скрипт в VM (временный файл)
    remote_script="/tmp/$(basename "$script").$$"
    scp $ssh_opts -P 2222 "$script" $name@$remote_host:"$remote_script"
    # Выполняем + удаляем
    cmd=$(printf '%q ' "$remote_script" "$@")
    ssh $ssh_opts -p 2222 $name@$remote_host 'chmod +x "'"$remote_script"'" && su -m root -c "'"$cmd"'" && rm "'"$remote_script"'"'
else
    # Выполняем команду напрямую
    cmd=$(printf '%q ' "$@")
    ssh $ssh_opts -p 2222 $name@$remote_host 'su -m root -c "'"$cmd"'"'
fi
