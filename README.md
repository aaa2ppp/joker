# Automated FreeBSD 15.0 VM setup for development

Если кратко -- это автоматизированная система для создания и управления виртуальной машиной FreeBSD 15.0 с предустановленными инструментами разработки (jails, ZFS, Go).

---

## Что именно добавлено/изменено:

Создана директория `vbox/` с набором скриптов и `Makefile` для:

### 1. `Makefile` -- основной управляющий скрипт
- Скачивание официального образа FreeBSD 15.0-RELEASE
- Создание эталонной VM в VirtualBox на основе снапшота
- Клонирование VM для проекта (`joker` -- имя примера)
- Управление ресурсами: память, CPU, диски
- Настройка сети: NAT с пробросом порта SSH (2222 -> 22)
- Автоматическая первоначальная конфигурация при первом запуске

### 2. Скрипты настройки (`first-boot.sh`, `joker.d/*`)
- Создание пользователя `joker` в группе `wheel` с отключённым паролем
- Настройка SSH-доступа по ключу (автогенерируемый `id_ed25519`)
- Включение и запуск `sshd`
- Установка и настройка `iocage` через этапы: ZFS-пул на дополнительном диске, модули сетевых интерфейсов, `bridge0`, установка пакетов (`sudo`, `git`, `go`, `mc` и др.)
- Монтирование общей папки (`projects`) через VirtualBox Guest Additions

### 3. Утилиты для работы с VM
- `joker` -- SSH-подключение к VM через порт 2222 с предзаполненным `known_hosts`
- `joker-run` -- выполнение локальных скриптов от root внутри VM через `ssh`
- `vbox-manage-path.sh` -- кросс-платформенное определение пути к `VBoxManage`
- `wait-for-sshd.sh` -- ожидание готовности SSH-демона с экспоненциальной задержкой
- `wait-for-poweroff.sh` -- ожидание выключения VM через ACPI

### 4. Работа с дисками и файловыми системами
- Основной диск -- VHD-образ FreeBSD 15.0-RELEASE с ZFS
- Дополнительный диск (`data.vdi`) для хранения данных и создания ZFS-пула
- Поддержка linked-клонов для экономии места

---

## Для чего это нужно?

1. **Быстрое развертывание** -- одна команда (`make create-joker`) создаёт готовую VM.
2. **Воспроизводимость** -- конфигурация описана в коде, работает одинаково на разных машинах.
3. **Разработка в jails** --
   - Полностью настроенное окружение для работы с iocage
   - Отдельный ZFS-пул для jail-данных
   - Возможность создавать шаблоны (например, `go-dev`)
4. **Комфортная разработка** --
   - Прямой SSH-доступ без пароля
   - Общая папка с хостом (`~/Projects` -> `/home/joker/projects`)
   - Установленные базовые инструменты (`go`, `git`, `sudo`, `mc` и др.)

---

## Пример использования

```bash
cd vbox
make create-freebsd    # скачать образ и создать эталонную VM
make create-joker      # создать рабочую VM "joker"
make start-joker       # запустить (автонастройка при первом запуске)

./joker uname -a       # выполнить команду в VM от пользователя joker
./joker-run test.sh    # запустить локальный скрипт в VM от root

make stop-joker        # выключить VM через ACPI
make clean             # полная очистка (сохраняется только data-диск)
```

Полная настройка среды разработки одной командой:

```bash
cd vbox
make init-jail-env     # установка и настройка всего окружения
```

Создание шаблона jail:

```bash
cd vbox
make .joker/create-go-dev-template
```

---

## Ключевые особенности

- **Официальный образ** -- используется `FreeBSD-15.0-RELEASE-amd64-zfs.vhd`
- **Linked-клонирование** -- VM создаётся как linked clone от снапшота `initial`
- **SSH-доступ без пароля** -- генерируется ed25519-ключ, публичная часть добавляется в `authorized_keys`
- **Дополнительный диск** -- отдельный `.vdi` для данных, автоматически форматируется в ZFS (`workpool`)
- **Кросс-платформенность** -- поддержка Linux, macOS и Windows (через Git Bash)

Это инфраструктура как код (IaC) для FreeBSD-окружения в VirtualBox, удобная для разработчиков, изучающих FreeBSD или работающих с jail-системами.
